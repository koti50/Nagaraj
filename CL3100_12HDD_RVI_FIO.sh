# This is to run a single scrip to get all the necessary runs on Arcee RVI
# make sure the fio parameter file 'fio arcee_12_hdd_seq_write_1M' is in the directory 
# Once finished with your data runs then reset the bmc to return to closed loop by running 'arcee_setfantoautoPWM.sh'

echo 'Gathering the /dev/sd* data to a file'
#hdparm -I /dev/sd* > sdlist.txt

# Set the fans to 30%PWM and echo actual
echo '30% PWM is 0x4c when you read the fan speed'
ipmitool raw 0x2e 0x1 0x1 0x0 0x4c #Sets fan 1 to 30% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x1 0x4c #Sets fan 2 to 30% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x2 0x4c #Sets fan 3 to 30% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x3 0x4c #Sets fan 4 to 30% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x4 0x4c #Sets fan 5 to 30% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x5 0x4c #Sets fan 6 to 30% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x6 0x4c #Sets fan 7 to 30% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x7 0x4c #Sets fan 8 to 30% PWM of 26000 rpm

sleep 5

# echo out the actual fan speeds
echo 'fan speed 1'
ipmitool raw 0x2e 0x1 0x0 0x0 0x0
echo 'fan speed 2'
ipmitool raw 0x2e 0x1 0x0 0x1 0x0
echo 'fan speed 3'
ipmitool raw 0x2e 0x1 0x0 0x2 0x0
echo 'fan speed 4'
ipmitool raw 0x2e 0x1 0x0 0x3 0x0
echo 'fan speed 5'
ipmitool raw 0x2e 0x1 0x0 0x4 0x0
echo 'fan speed 6'
ipmitool raw 0x2e 0x1 0x0 0x5 0x0
echo 'fan speed 7'
ipmitool raw 0x2e 0x1 0x0 0x6 0x0
echo 'fan speed 8'
ipmitool raw 0x2e 0x1 0x0 0x7 0x0

sleep 5

# Run fio on Arcee and create a data file
echo 'Running fio with 30 PWM which is "4c" reported'
./fio FIO_BW_SEQ_WRITE_1MB > arcee_30PWM_1M_seqwrite_180s.txt

sleep 5

# Set the fans to 42%PWM and echo actual
echo '42% PWM is 0x6d when you read the fan speed'
ipmitool raw 0x2e 0x1 0x1 0x0 0x6d #Sets fan 1 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x1 0x6d #Sets fan 2 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x2 0x6d #Sets fan 3 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x3 0x6d #Sets fan 4 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x4 0x6d #Sets fan 5 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x5 0x6d #Sets fan 6 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x6 0x6d #Sets fan 7 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x7 0x6d #Sets fan 8 to 42% PWM of 26000 rpm

sleep 5

# echo out the actual fan speeds
echo 'fan speed 1'
ipmitool raw 0x2e 0x1 0x0 0x0 0x0
echo 'fan speed 2'
ipmitool raw 0x2e 0x1 0x0 0x1 0x0
echo 'fan speed 3'
ipmitool raw 0x2e 0x1 0x0 0x2 0x0
echo 'fan speed 4'
ipmitool raw 0x2e 0x1 0x0 0x3 0x0
echo 'fan speed 5'
ipmitool raw 0x2e 0x1 0x0 0x4 0x0
echo 'fan speed 6'
ipmitool raw 0x2e 0x1 0x0 0x5 0x0
echo 'fan speed 7'
ipmitool raw 0x2e 0x1 0x0 0x6 0x0
echo 'fan speed 8'
ipmitool raw 0x2e 0x1 0x0 0x7 0x0

sleep 5

# Run fio on Arcee and create a data file
echo 'Running fio with 42 PWM which is "62" reported'
./fio FIO_BW_SEQ_WRITE_1MB > arcee_42PWM_1M_seqwrite_180s.txt

sleep 5

# Set the fans to 100%PWM and echo actual
echo '100% PWM is 0xff when you read the fan speed'
ipmitool raw 0x2e 0x1 0x1 0x0 0xff #Sets fan 1 to 100% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x1 0xff #Sets fan 2 to 100% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x2 0xff #Sets fan 3 to 100% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x3 0xff #Sets fan 4 to 100% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x4 0xff #Sets fan 5 to 100% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x5 0xff #Sets fan 6 to 100% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x6 0xff #Sets fan 7 to 100% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x7 0xff #Sets fan 8 to 100% PWM of 26000 rpm

sleep 5

# echo out the actual fan speeds
echo 'fan speed 1'
ipmitool raw 0x2e 0x1 0x0 0x0 0x0
echo 'fan speed 2'
ipmitool raw 0x2e 0x1 0x0 0x1 0x0
echo 'fan speed 3'
ipmitool raw 0x2e 0x1 0x0 0x2 0x0
echo 'fan speed 4'
ipmitool raw 0x2e 0x1 0x0 0x3 0x0
echo 'fan speed 5'
ipmitool raw 0x2e 0x1 0x0 0x4 0x0
echo 'fan speed 6'
ipmitool raw 0x2e 0x1 0x0 0x5 0x0
echo 'fan speed 7'
ipmitool raw 0x2e 0x1 0x0 0x6 0x0
echo 'fan speed 8'
ipmitool raw 0x2e 0x1 0x0 0x7 0x0

sleep 5

# Run fio on Arcee and create a data file
echo 'Running fio with 100 PWM which is "ff" reported'
./fio FIO_BW_SEQ_WRITE_1MB > arcee_100PWM_1M_seqwrite_180s.txt

sleep 5

# Set the fans to 42%PWM and echo actual
echo 'setting fan speeds to nominal 42%PWM'
echo '42% PWM is 0x6d when you read the fan speed'
ipmitool raw 0x2e 0x1 0x1 0x0 0x6d #Sets fan 1 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x1 0x6d #Sets fan 2 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x2 0x6d #Sets fan 3 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x3 0x6d #Sets fan 4 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x4 0x6d #Sets fan 5 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x5 0x6d #Sets fan 6 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x6 0x6d #Sets fan 7 to 42% PWM of 26000 rpm
ipmitool raw 0x2e 0x1 0x1 0x7 0x6d #Sets fan 8 to 42% PWM of 26000 rpm

sleep 5

# echo out the actual fan speeds
echo 'fan speed 1'
ipmitool raw 0x2e 0x1 0x0 0x0 0x0
echo 'fan speed 2'
ipmitool raw 0x2e 0x1 0x0 0x1 0x0
echo 'fan speed 3'
ipmitool raw 0x2e 0x1 0x0 0x2 0x0
echo 'fan speed 4'
ipmitool raw 0x2e 0x1 0x0 0x3 0x0
echo 'fan speed 5'
ipmitool raw 0x2e 0x1 0x0 0x4 0x0
echo 'fan speed 6'
ipmitool raw 0x2e 0x1 0x0 0x5 0x0
echo 'fan speed 7'
ipmitool raw 0x2e 0x1 0x0 0x6 0x0
echo 'fan speed 8'
ipmitool raw 0x2e 0x1 0x0 0x7 0x0
